version: '2'
services:
  postgres:
    image: postgres:9.6.1
    container_name: template_stack_postgres
    volumes:
      - ./.data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=template_stack
      - POSTGRES_PASSWORD=template_stack
      - POSTGRES_DB=template_stack
  redis:
    image: redis
    container_name: template_stack_redis
    volumes:
      - ./.data/redis:/data
  nats:
    image: nats
    container_name: template_stack_nats
  frontend:
    build:
      context: ./
      dockerfile: Dockerfile.frontend
    ports:
      - "80:80"
    container_name: template_stack_frontend
    environment:
      - MANUALRUN
    volumes:
      - ./frontend:/app/frontend
      - /app/frontend/node_modules/
      - ./template-ui:/app/frontend/node_modules/template-ui
      - ./template-tools:/app/frontend/node_modules/template-tools
      - ./shared:/app/frontend/node_modules/shared
    entrypoint:
      - "bash"
      - "run.sh"
  api:
    build:
      context: ./
      dockerfile: Dockerfile.api
    container_name: template_stack_api
    environment:
      - MANUALRUN
      - POSTGRES_SERVICE_USER=template_stack
      - POSTGRES_SERVICE_PASSWORD=template_stack
      - POSTGRES_SERVICE_DATABASE=template_stack
      - COOKIE_SECRET=apples
    volumes:
      - ./api:/app/api
      - /app/api/node_modules/
      - ./template-api:/app/api/node_modules/template-api
      - ./template-tools:/app/frontend/node_modules/template-tools
      - ./shared:/app/api/node_modules/shared
    entrypoint:
      - "bash"
      - "run.sh"